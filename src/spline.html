<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="IK.js"></script>
    <script>
     window.onload = function(){
       var svg = d3.select("svg");
       var t = _.range(0, 1.0, 0.01);
       var w = window.innerWidth;
       var h = window.innerHeight;
       var p = [
         [w/2 - w/5, h/2],
         [w/2 + w/5, h/2]
       ];
       var m = [
         [0., h/5],
         [0., h/5]
       ];

       function h00(t){return 2*t*t*t-3*t*t+1;}
       function h10(t){return t*t*t-2*t*t+t;}
       function h01(t){return -2*t*t*t+3*t*t;}
       function h11(t){return t*t*t-t*t;}
       function px(t){return h00(t)*p[0][0]+h10(t)*3*m[0][0]+h01(t)*p[1][0]+h11(t)*3*m[1][0];}
       function py(t){return h00(t)*p[0][1]+h10(t)*3*m[0][1]+h01(t)*p[1][1]+h11(t)*3*m[1][1];}

       function drawSpline(){
         var line = d3.svg.line()
                      .x(function(d){return px(d);})
                      .y(function(d){return py(d);});

         svg.append("path")
            .datum(t)
            .attr({
              stroke: "black",
              "stroke-width": 3,
              fill: "none",
              d: line
            });
       }

       _.each([0, 1], function(i){
         var cattr = {
           r: 10,
           fill: "steelblue",
           stroke: "white",
           "stroke-width": 3,
           draggable: "true"
         };

         svg.append("circle")
          .attr(_.extend({
            cx: p[i][0],
            cy: p[i][1]
          }, cattr));

         var c = svg.append("circle");
         var l = svg.append("line");

         c.call(d3.behavior.drag()
                      .on("drag", function(){
                        m[i][0] += d3.event.dx;
                        m[i][1] += d3.event.dy;
                        update();
                      })
                      .on("dragend", function(){
                        svg.select("path").remove();
                        drawSpline();
                      }));

         function update(){
           c.attr(_.extend({
             cx: p[i][0] + m[i][0],
             cy: p[i][1] + m[i][1]
           }, cattr));

           l.attr({
             x1: p[i][0] + m[i][0],
             y1: p[i][1] + m[i][1],
             x2: p[i][0],
             y2: p[i][1],
             stroke: "black",
             "stroke-width": 3
           });
         }

         update();
       });
       drawSpline();
     }
    </script>
  </head>
  <body>
    <svg style="width:100%; height: 100%;"></svg>
  </body>
</html>
